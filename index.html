<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma Parque BMW</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configurar a nossa cor Azul BMW no Tailwind
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bmw: '#0066B1'
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen bg-white font-sans text-slate-800">

    <header class="bg-white border-b border-gray-200 sticky top-0 z-10 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center pt-4 sm:pt-0 sm:h-16">
                
                <div class="flex-shrink-0 flex items-center mb-4 sm:mb-0">
                    <h1 class="text-2xl font-bold text-bmw">
                        PARQUE <span class="text-gray-800">BMW</span>
                    </h1>
                </div>

                <nav class="flex space-x-6 overflow-x-auto" id="nav-tabs">
                    <button onclick="mudarTab('parque')" id="tab-parque" class="px-1 pb-3 sm:py-4 text-sm font-medium border-b-2 whitespace-nowrap transition-colors border-bmw text-bmw">
                        Parque
                    </button>
                    <button onclick="mudarTab('especificacoes')" id="tab-especificacoes" class="px-1 pb-3 sm:py-4 text-sm font-medium border-b-2 whitespace-nowrap transition-colors border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        Especificações
                    </button>
                </nav>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 sm:py-8">
        
        <div id="conteudo-parque" class="block">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-semibold text-gray-800">Inventário e Preços</h2>
            </div>

            <div id="loading" class="flex justify-center items-center h-64">
                <p class="text-bmw font-medium animate-pulse">A calcular preços em tempo real...</p>
            </div>

            <div id="dados-viaturas" class="hidden">
                
                <div id="grid-mobile" class="block lg:hidden space-y-4">
                    </div>

                <div class="hidden lg:block bg-white border border-gray-200 shadow-sm rounded-lg overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Viatura</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Local</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Estado</th>
                                <th class="px-6 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">PVP Base</th>
                                <th class="px-6 py-3 text-right text-xs font-bold text-bmw uppercase tracking-wider">PVP Final (NET)</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-desktop" class="bg-white divide-y divide-gray-100">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="conteudo-especificacoes" class="hidden">
            <div class="bg-gray-50 border border-gray-200 border-dashed rounded-lg h-96 flex items-center justify-center m-4 sm:m-0">
                <div class="text-center px-4">
                    <h3 class="text-lg font-medium text-gray-900">Módulo de Especificações</h3>
                    <p class="mt-1 text-sm text-gray-500">Área reservada para desenvolvimento futuro da dinâmica de especificações.</p>
                </div>
            </div>
        </div>

    </main>

    <script>
        // ATENÇÃO: Substitui estas variáveis pelas tuas chaves do Supabase
        const SUPABASE_URL = 'COLA_AQUI_O_TEU_SUPABASE_URL';
        const SUPABASE_ANON_KEY = 'COLA_AQUI_A_TUA_SUPABASE_ANON_KEY';

        // Lógica para mudar de separadores (Tabs)
        function mudarTab(tab) {
            // Controlar os botões
            document.getElementById('tab-parque').className = tab === 'parque' 
                ? 'px-1 pb-3 sm:py-4 text-sm font-medium border-b-2 whitespace-nowrap transition-colors border-bmw text-bmw' 
                : 'px-1 pb-3 sm:py-4 text-sm font-medium border-b-2 whitespace-nowrap transition-colors border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300';
            
            document.getElementById('tab-especificacoes').className = tab === 'especificacoes' 
                ? 'px-1 pb-3 sm:py-4 text-sm font-medium border-b-2 whitespace-nowrap transition-colors border-bmw text-bmw' 
                : 'px-1 pb-3 sm:py-4 text-sm font-medium border-b-2 whitespace-nowrap transition-colors border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300';

            // Controlar o conteúdo visível
            document.getElementById('conteudo-parque').style.display = tab === 'parque' ? 'block' : 'none';
            document.getElementById('conteudo-especificacoes').style.display = tab === 'especificacoes' ? 'block' : 'none';
        }

        // Função para ir buscar os dados à Edge Function do Supabase
        async function carregarViaturas() {
            const loadingDiv = document.getElementById('loading');
            const dadosDiv = document.getElementById('dados-viaturas');
            
            try {
                // Chamamos a Edge Function que tem o nosso motor de cálculo em tempo real
                const response = await fetch(`${SUPABASE_URL}/functions/v1/calcular-precos-viaturas`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (!response.ok) throw new Error('Erro ao carregar dados');
                
                const viaturas = await response.json();
                renderizarDados(viaturas);
                
                // Esconder o aviso de "A calcular..." e mostrar a tabela/cartões
                loadingDiv.style.display = 'none';
                dadosDiv.style.display = 'block';

            } catch (error) {
                console.error("Erro:", error);
                loadingDiv.innerHTML = '<p class="text-red-600 font-medium">Erro ao comunicar com o servidor de preços.</p>';
            }
        }

        // Função para desenhar o HTML com os dados que vieram do servidor
        function renderizarDados(viaturas) {
            const gridMobile = document.getElementById('grid-mobile');
            const tabelaDesktop = document.getElementById('tabela-desktop');
            
            let htmlMobile = '';
            let htmlDesktop = '';

            viaturas.forEach(carro => {
                const pvpBruto = carro.calculos ? `${carro.calculos.pvp_bruto} €` : 'N/A';
                const pvpFinal = carro.calculos ? `${carro.calculos.pvp_final} €` : 'N/A';

                // Desenhar Cartão Mobile
                htmlMobile += `
                    <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-4 hover:border-bmw transition-colors">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h3 class="text-base font-bold text-gray-900">${carro.modelo} ${carro.versao}</h3>
                                <p class="text-xs text-gray-500">Chassis: ${carro.chassis}</p>
                            </div>
                            <span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs font-medium">${carro.local}</span>
                        </div>
                        <div class="text-sm text-gray-600 mb-4">Estado: ${carro.estado_entrega}</div>
                        <div class="flex justify-between items-end border-t border-gray-100 pt-3">
                            <div>
                                <div class="text-xs text-gray-500 uppercase">PVP Base</div>
                                <div class="text-sm text-gray-600">${pvpBruto}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-bmw font-bold uppercase">PVP Final (NET)</div>
                                <div class="text-lg font-bold text-bmw">${pvpFinal}</div>
                            </div>
                        </div>
                    </div>
                `;

                // Desenhar Linha da Tabela Desktop
                htmlDesktop += `
                    <tr class="hover:bg-blue-50/50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-bold text-gray-900">${carro.modelo} ${carro.versao}</div>
                            <div class="text-xs text-gray-500">Chassis: ${carro.chassis}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${carro.local}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${carro.estado_entrega}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-500">${pvpBruto}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right font-bold text-bmw text-lg">${pvpFinal}</td>
                    </tr>
                `;
            });

            gridMobile.innerHTML = htmlMobile;
            tabelaDesktop.innerHTML = htmlDesktop;
        }

        // Iniciar o carregamento de viaturas assim que a página abre
        window.onload = carregarViaturas;
    </script>
</body>
</html>
